---
title: "Life Analytics Framework"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
date: '2022-04-02'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(gt)
library(data.table)
library(tidyverse)
library(dtplyr)
library(fst)
```

# Parameters and Data Setup {.tabset}

```{r params}
## Dataset parameters
useLocalData <- TRUE
localRDSPath <- "/mnt/c/users/phili/Downloads/ilec.dat.fst"
srcPath <- "/mnt/d/Projects/ILEC/2009-2018/ILEC 2009-18 20210528.csv"

## Compute parameters
nCores <- 4

## EDA parameters
# FSA
useFSA <- FALSE
checkInteractions <- c(2,3)
limitInteractions <- c()

# Prescribed cuts
usePrescribedDimensions <- TRUE
prescDims <- list(
  list(c("Gender"),c("Gender")),
  list(c("Gender","Smoker_Status"),c("Gender","Smoker Status"))
)
# Specify as a list of lists. 
# Each member list is a pair of vectors:
#  the variables to summarize on and how to label them in the output tables

## Modeling parameters
# GLMs
runGLMs <- FALSE
partitionGLMsBy <- c()
includeVars <- c()
targetVar <- "Number_Of_Deaths"
offset <- "Expected_Death_QX2015VBT_by_Policy"
familyGLM <- poisson
# For A/E analysis, use an expected death column, for raw mortality, use an exposure column
# For count, use number of deaths, a by count offset, and poisson
# For amount, use death claim amount, a by amount offset, and quasipoisson

# Note that stepwise modeling is not available for the quasipoisson case, 
# but the FSA approach probably is.

# Catboost


```

## Dataset Parameters

The dataset is loaded from a pre-processed file or from a remote source of your choosing. 

### Pre-processed file

A pre-processed RDS file is recommended to save time. See issues below regarding loading the 2009-2018 CSV. About 33 GB is needed for the pre-processed object. 

### CSV from ILEC

If running without benefit of a pre-processed file, specify the location of your source data in srcPath. This is assumed to be something that rio::import can read and that will be converted into a data.table object.

For the 2009-2018 data, about 52 GB of memory was used to load and process the data. The entirety of the dataset once loaded from this process requires 33 GB.

Note that .ZIP files are unzipped using unzip in R, which appears to have difficulty with larger than 4GB files. Therefore, either use an already-unpacked CSV or use a .GZ archive. Note that rio::import can accept URLs, so something like https://your.server/your.file.csv.gz is valid.

## EDA Parameters


## Models

### GLMs

### Gradient Boosted Machines with Catboost

```{r dataload}
if(useLocalData) {
  #ilec.dat <- readRDS(file = localRDSPath)
  ilec.dat <- read_fst(path=localRDSPath, as.data.table=T)
} else {
  source("Data Prep.R")
}
```

# Exploratory Data Analysis {.tabset}

```{r eda-cuts}
if(usePrescribedDimensions) {
  source("summaryTables.R")
  
  #lapply(prescDims,
  #     function(l)
  #       print(summaryTable(.data=ilec.dat,
  #                    .dimList=l))
  #)
  for(i in 1:max(1,length(prescDims)) ) {
    if(length(prescDims) > 0)
      .dimList <- prescDims[[i]]
    else
      .dimList <- NULL
    
    if(is.null(.dimList)) {
      sumtbl <- ilec.dat[Observation_Year <= 2017,
                         .(Number_Of_Deaths=sum(Number_Of_Deaths),
                           Expected_Death_QX2015VBT_by_Policy=sum(Expected_Death_QX2015VBT_by_Policy),
                           A_E_Policy=sum(Number_Of_Deaths)/sum(Expected_Death_QX2015VBT_by_Policy),
                           Policies_Exposed=sum(Policies_Exposed),
                           Policies_Exposed_Prop=sum(Policies_Exposed),
                           Death_Claim_Amount=sum(Death_Claim_Amount),
                           Expected_Death_QX2015VBT_by_Amount=sum(Expected_Death_QX2015VBT_by_Amount),
                           A_E_Amount=sum(Death_Claim_Amount)/sum(Expected_Death_QX2015VBT_by_Amount),
                           Amount_Exposed=sum(Amount_Exposed),
                           Amount_Exposed_Prop=sum(Amount_Exposed)),
                         by=eval(.dimList[[1]])
      ][,
        `:=`(Policies_Exposed_Prop=Policies_Exposed/sum(Policies_Exposed),
             Amount_Exposed_Prop=Amount_Exposed/sum(Amount_Exposed)
        )] %>% 
        gt() %>%
        tab_header(
          title="Summary claim statistics vs. 2015VBT"
        )
    }
    else {
      sumtbl <- ilec.dat[Observation_Year <= 2017,
                       .(Number_Of_Deaths=sum(Number_Of_Deaths),
                         Expected_Death_QX2015VBT_by_Policy=sum(Expected_Death_QX2015VBT_by_Policy),
                         A_E_Policy=sum(Number_Of_Deaths)/sum(Expected_Death_QX2015VBT_by_Policy),
                         Policies_Exposed=sum(Policies_Exposed),
                         Policies_Exposed_Prop=sum(Policies_Exposed),
                         Death_Claim_Amount=sum(Death_Claim_Amount),
                         Expected_Death_QX2015VBT_by_Amount=sum(Expected_Death_QX2015VBT_by_Amount),
                         A_E_Amount=sum(Death_Claim_Amount)/sum(Expected_Death_QX2015VBT_by_Amount),
                         Amount_Exposed=sum(Amount_Exposed),
                         Amount_Exposed_Prop=sum(Amount_Exposed)),
                       by=eval(.dimList[[1]])
    ][,
      `:=`(Policies_Exposed_Prop=Policies_Exposed/sum(Policies_Exposed),
           Amount_Exposed_Prop=Amount_Exposed/sum(Amount_Exposed)
      )] %>% 
      gt() %>%
      tab_header(
        title="Summary claim statistics vs. 2015VBT",
        subtitle=paste0("by ",paste(.dimList[[2]],collapse=", "))
      )
    } 
    
    sumtbl <- sumtbl %>%
      tab_spanner(
        label="by count",
        columns = c(
          Number_Of_Deaths,
          Expected_Death_QX2015VBT_by_Policy,
          A_E_Policy,
          Policies_Exposed,
          Policies_Exposed_Prop
        )
      ) %>%
      tab_spanner(
        label="by amount",
        columns = c(
          Death_Claim_Amount,
          Expected_Death_QX2015VBT_by_Amount,
          A_E_Amount,
          Amount_Exposed,
          Amount_Exposed_Prop
        )
      ) %>%
      fmt_integer(
        columns = Number_Of_Deaths
      ) %>%
      fmt_percent(
        columns=c(A_E_Policy,Policies_Exposed_Prop,
                  A_E_Amount,Amount_Exposed_Prop),
        decimals = 1
      ) %>%
      fmt_number(
        columns=c(Expected_Death_QX2015VBT_by_Policy)
      ) %>% 
      fmt_number(
        columns=c(Policies_Exposed),
        suffixing = T
      ) %>% 
      fmt_currency(
        columns=c(
          Death_Claim_Amount,
          Expected_Death_QX2015VBT_by_Amount,
          Amount_Exposed),
        suffixing = T
      ) %>% 
      cols_label(
        Number_Of_Deaths="Actual Deaths",
        Expected_Death_QX2015VBT_by_Policy="Tabular Deaths",
        A_E_Policy="Actual-to-Tabular",
        Policies_Exposed="Policies Exposed",
        Policies_Exposed_Prop="Proportion Exposure",
        Death_Claim_Amount="Actual Amount",
        Expected_Death_QX2015VBT_by_Amount="Tabular Amount",
        A_E_Amount="Actual-to-Tabular",
        Amount_Exposed_Prop="Proportion Exposure"
      ) 
    
    if(!is.null(.dimList)) {
      sumtbl <- sumtbl %>% 
        cols_label(
          .list = purrr::set_names(as.list(.dimList[[2]]),
                                   .dimList[[1]])
        )
    }
    
    print(sumtbl)
    rm(sumtbl)
  }
}
```

```{r eda-fsa}
if(useFSA) {
  
}
```

# Models {.tabset}

